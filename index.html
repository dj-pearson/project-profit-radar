<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      type="image/x-icon"
      href="https://ilhzuvemiuyfuxfegtlv.supabase.co/storage/v1/object/public/site-assets//favicon.ico"
    />
    <meta name="theme-color" content="#ff6b00" />
    <link rel="manifest" href="/manifest.json" />
    <link
      rel="apple-touch-icon"
      href="https://ilhzuvemiuyfuxfegtlv.supabase.co/storage/v1/object/public/site-assets//BuildDeskLogo.png"
    />

    <title>BuildDesk - Construction Management Platform</title>
    <meta
      name="description"
      content="Construction management platform built for growing teams. Real-time project visibility without enterprise complexity."
    />
    <meta name="author" content="BuildDesk" />

    <meta
      property="og:title"
      content="BuildDesk - Construction Management Platform"
    />
    <meta
      property="og:description"
      content="Construction management platform built for growing teams. Real-time project visibility without enterprise complexity."
    />
    <meta property="og:type" content="website" />
    <meta
      property="og:image"
      content="https://ilhzuvemiuyfuxfegtlv.supabase.co/storage/v1/object/public/site-assets//BuildDeskLogo.png"
    />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@builddesk" />
    <meta
      name="twitter:image"
      content="https://ilhzuvemiuyfuxfegtlv.supabase.co/storage/v1/object/public/site-assets//BuildDeskLogo.png"
    />

    <!-- IMMEDIATE Cache Clear Script -->
    <script>
      (function () {
        // FORCE immediate cache clear if we detect old behavior
        const CURRENT_VERSION = "2025.01.03.002";
        const lastCacheClear = localStorage.getItem("last_cache_clear");
        const now = Date.now();

        // Force cache clear if more than 30 seconds since last clear or version mismatch
        const shouldForceClear =
          !lastCacheClear ||
          now - parseInt(lastCacheClear) > 30000 ||
          localStorage.getItem("builddesk_version") !== CURRENT_VERSION;

        if (shouldForceClear) {
          console.log("üö® IMMEDIATE CACHE CLEAR v" + CURRENT_VERSION);

          // Clear everything immediately
          try {
            localStorage.clear();
            sessionStorage.clear();

            // Clear service worker and caches
            if ("serviceWorker" in navigator) {
              navigator.serviceWorker.getRegistrations().then((regs) => {
                regs.forEach((reg) => reg.unregister());
              });
            }

            if ("caches" in window) {
              caches.keys().then((names) => {
                names.forEach((name) => caches.delete(name));
              });
            }

            // Set new timestamp
            localStorage.setItem("last_cache_clear", now.toString());
            localStorage.setItem("builddesk_version", CURRENT_VERSION);

            // Force reload with aggressive cache busting
            const params = new URLSearchParams(window.location.search);
            params.set("v", CURRENT_VERSION);
            params.set("t", now.toString());
            params.set("cache_clear", "immediate");

            const newURL =
              window.location.origin +
              window.location.pathname +
              "?" +
              params.toString();

            // Only reload if we're not already in a cache clear reload
            if (!params.has("cache_clear")) {
              console.log("üîÑ IMMEDIATE RELOAD:", newURL);
              window.location.href = newURL;
              return; // Stop execution
            }
          } catch (e) {
            console.error("Cache clear error:", e);
          }
        }

        // Enhanced protection against infinite renders
        let accessGrantedCount = 0;
        let lastAccessGranted = 0;
        let emergencyTriggered = false;

        // Override console.log to catch infinite renders immediately
        const originalLog = console.log;
        console.log = function (...args) {
          const logStr = args.join(" ");

          // Detect infinite access granted messages
          if (logStr.includes("‚úÖ EMERGENCY: Access granted for role:")) {
            accessGrantedCount++;
            const now = Date.now();

            // If more than 5 access granted messages in 2 seconds = infinite render
            if (now - lastAccessGranted < 2000 && accessGrantedCount > 5) {
              if (!emergencyTriggered) {
                emergencyTriggered = true;
                console.error(
                  "üö® INFINITE RENDER DETECTED! Force clearing cache immediately..."
                );

                // Show immediate warning
                document.body.innerHTML = `
                  <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #dc2626; color: white; z-index: 99999; display: flex; align-items: center; justify-content: center; font-family: Arial, sans-serif;">
                    <div style="text-align: center; padding: 20px;">
                      <h1 style="margin: 0 0 20px 0; font-size: 24px;">üö® EMERGENCY CACHE CLEAR</h1>
                      <p style="margin: 0; font-size: 18px;">Infinite render detected - clearing cache...</p>
                      <div style="margin-top: 20px; width: 200px; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px;">
                        <div style="width: 100%; height: 100%; background: white; animation: pulse 1s infinite;"></div>
                      </div>
                      <style>
                        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
                      </style>
                    </div>
                  </div>
                `;

                // Force immediate cache clear and reload
                setTimeout(() => {
                  try {
                    localStorage.clear();
                    sessionStorage.clear();

                    if ("caches" in window) {
                      caches.keys().then((names) => {
                        names.forEach((name) => caches.delete(name));
                      });
                    }

                    const timestamp = Date.now();
                    const newURL =
                      window.location.origin +
                      "/auth?emergency_render_fix=" +
                      timestamp +
                      "&force_new_session=true";
                    window.location.href = newURL;
                  } catch (e) {
                    window.location.reload(true);
                  }
                }, 1000);

                return; // Don't log the problematic message
              }
            }

            // Reset counter after time period
            if (now - lastAccessGranted > 2000) {
              accessGrantedCount = 1;
            }
            lastAccessGranted = now;
          }

          // Check for auth navigation fix
          if (
            logStr.includes(
              "‚úÖ FIXED AUTH: User authenticated, navigating to dashboard"
            )
          ) {
            console.log("‚úÖ NEW VERSION DETECTED: Navigation fix active!");
          }

          originalLog.apply(console, args);
        };

        // Detect React error 301 and force reload
        const originalError = console.error;
        console.error = function (...args) {
          const errorStr = args.join(" ");

          if (
            errorStr.includes("Minified React error #301") &&
            !emergencyTriggered
          ) {
            emergencyTriggered = true;
            console.error("üö® REACT ERROR 301 DETECTED! Clearing cache...");

            setTimeout(() => {
              localStorage.clear();
              sessionStorage.clear();
              const timestamp = Date.now();
              window.location.href =
                window.location.origin + "/auth?react_error_fix=" + timestamp;
            }, 500);
          }

          originalError.apply(console, args);
        };

        console.log("üõ°Ô∏è IMMEDIATE PROTECTION v" + CURRENT_VERSION + ": Active");
      })();
    </script>
  </head>

  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
