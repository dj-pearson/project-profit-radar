<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Font Loading Optimization -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@400;500;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@400;500;600;700&display=swap" rel="stylesheet"></noscript>
    
    <!-- Favicon and PWA meta tags -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <meta name="theme-color" content="#ff6b00" />
    <link rel="manifest" href="/manifest.json" />
    
    <!-- PWA meta tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="BuildDesk">
    
    
    <link
      rel="apple-touch-icon"
      href="https://ilhzuvemiuyfuxfegtlv.supabase.co/storage/v1/object/public/site-assets//BuildDeskLogo.png"
    />

    <title>BuildDesk - Construction Management Software for Small Contractors | Job Costing & Scheduling</title>
    <meta
      name="description"
      content="Construction management software designed for small-mid contractors. Real-time job costing, mobile crew tracking, OSHA compliance, QuickBooks sync. 50% less than competitors. Free trial."
    />
    <meta name="keywords" content="construction management software, job costing software, construction scheduling, OSHA compliance, contractor software, QuickBooks integration, construction time tracking" />
    <meta name="author" content="BuildDesk" />
    <link rel="canonical" href="https://builddesk.com" />

    <meta
      property="og:title"
      content="BuildDesk - Construction Management Software for Small Contractors"
    />
    <meta
      property="og:description"
      content="Construction management software designed for small-mid contractors. Real-time job costing, mobile crew tracking, OSHA compliance, QuickBooks sync. 50% less than competitors."
    />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://builddesk.com" />
    <meta
      property="og:image"
      content="https://ilhzuvemiuyfuxfegtlv.supabase.co/storage/v1/object/public/site-assets//BuildDeskLogo.png"
    />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@builddesk" />
    <meta name="twitter:title" content="BuildDesk - Construction Management Software for Small Contractors" />
    <meta name="twitter:description" content="Construction management software for small contractors. Job costing, scheduling, OSHA compliance. 50% less than competitors." />
    <meta
      name="twitter:image"
      content="https://ilhzuvemiuyfuxfegtlv.supabase.co/storage/v1/object/public/site-assets//BuildDeskLogo.png"
    />

    <!-- Organization Schema -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "BuildDesk",
      "url": "https://builddesk.com",
      "logo": "https://builddesk.com/images/builddesk-logo.png",
      "description": "Construction management software for small and mid-size contractors in the United States.",
      "address": {
        "@type": "PostalAddress",
        "addressCountry": "US"
      },
      "sameAs": [
        "https://linkedin.com/company/builddesk",
        "https://twitter.com/builddesk"
      ],
      "contactPoint": {
        "@type": "ContactPoint",
        "contactType": "Customer Service",
        "areaServed": "US",
        "availableLanguage": "English"
      }
    }
    </script>

    <!-- WebSite Schema -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "BuildDesk",
      "url": "https://builddesk.com",
      "description": "Construction management software for small contractors",
      "potentialAction": {
        "@type": "SearchAction",
        "target": {
          "@type": "EntryPoint",
          "urlTemplate": "https://builddesk.com/search?q={search_term_string}"
        },
        "query-input": "required name=search_term_string"
      }
    }
    </script>

    <!-- Google tag (gtag.js) - Deferred to idle time for performance -->
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-LNDT7H4SJR');
      
      // Load gtag.js during browser idle time to avoid blocking initial render
      function loadAnalytics() {
        var script = document.createElement('script');
        script.async = true;
        script.src = 'https://www.googletagmanager.com/gtag/js?id=G-LNDT7H4SJR';
        document.head.appendChild(script);
      }
      
      // Use requestIdleCallback for better performance, fallback to setTimeout
      if ('requestIdleCallback' in window) {
        requestIdleCallback(loadAnalytics, { timeout: 2000 });
      } else {
        setTimeout(loadAnalytics, 2000);
      }
    </script>

    <!-- Cache Management & Loop Protection -->
    <script>
      (function () {
        const CURRENT_VERSION = "2025.08.08.006";
        const lastCacheClear = localStorage.getItem("last_cache_clear");
        const now = Date.now();

        // Clean up URL parameters immediately to avoid redirect detection
        const params = new URLSearchParams(window.location.search);
        if (params.has("refreshed") || params.has("v")) {
          const cleanURL = window.location.origin + window.location.pathname;
          window.history.replaceState({}, '', cleanURL);
        }

        // Periodic cache refresh (once per hour)
        const shouldRefreshCache =
          !lastCacheClear ||
          now - parseInt(lastCacheClear) > 3600000 ||
          localStorage.getItem("app_version") !== CURRENT_VERSION;

        if (shouldRefreshCache) {
          try {
            localStorage.setItem("last_cache_clear", now.toString());
            localStorage.setItem("app_version", CURRENT_VERSION);

            if ("serviceWorker" in navigator) {
              navigator.serviceWorker.getRegistrations().then((regs) => {
                regs.forEach((reg) => reg.unregister());
              });
            }

            if ("caches" in window) {
              caches.keys().then((names) => {
                names.forEach((name) => caches.delete(name));
              });
            }

            // Clear storage without URL redirect
            localStorage.clear();
            sessionStorage.clear();
            localStorage.setItem("last_cache_clear", now.toString());
            localStorage.setItem("app_version", CURRENT_VERSION);
          } catch (e) {
            console.error("Cache refresh error:", e);
          }
        }

        // Silent protection against infinite renders
        let accessGrantedCount = 0;
        let lastAccessGranted = 0;
        let protectionActive = false;

        const originalLog = console.log;
        console.log = function (...args) {
          const logStr = args.join(" ");

          // Detect infinite access granted messages
          if (logStr.includes("Access granted for role:")) {
            accessGrantedCount++;
            const now = Date.now();

            if (now - lastAccessGranted < 2000 && accessGrantedCount > 5) {
              if (!protectionActive) {
                protectionActive = true;

                // Silent cache clear and reload
                setTimeout(() => {
                  try {
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.href = window.location.origin + "/auth";
                  } catch (e) {
                    window.location.reload(true);
                  }
                }, 500);

                return;
              }
            }

            if (now - lastAccessGranted > 2000) {
              accessGrantedCount = 1;
            }
            lastAccessGranted = now;
          }

          originalLog.apply(console, args);
        };

        // Silent React error handling
        const originalError = console.error;
        console.error = function (...args) {
          const errorStr = args.join(" ");

          if (
            errorStr.includes("Minified React error #301") &&
            !protectionActive
          ) {
            protectionActive = true;
            setTimeout(() => {
              localStorage.clear();
              sessionStorage.clear();
              window.location.href = window.location.origin + "/auth";
            }, 300);
          }

          originalError.apply(console, args);
        };
      })();
    </script>
  </head>

  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
