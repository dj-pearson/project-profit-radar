<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Permissions Policy to prevent console warnings -->
    <meta http-equiv="Permissions-Policy" content="vr=(), ambient-light-sensor=(), battery=(), geolocation=(self), camera=(self), microphone=(self)" />
    <!-- Multiple favicon sizes for better compatibility -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <meta name="theme-color" content="#ff6b00" />
    <link rel="manifest" href="/manifest.json" />
    
    <!-- PWA meta tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="BuildDesk">
    
    
    <link
      rel="apple-touch-icon"
      href="https://ilhzuvemiuyfuxfegtlv.supabase.co/storage/v1/object/public/site-assets//BuildDeskLogo.png"
    />

    <title>BuildDesk - Construction Management Platform</title>
    <meta
      name="description"
      content="Construction management platform built for growing teams. Real-time project visibility without enterprise complexity."
    />
    <meta name="author" content="BuildDesk" />

    <meta
      property="og:title"
      content="BuildDesk - Construction Management Platform"
    />
    <meta
      property="og:description"
      content="Construction management platform built for growing teams. Real-time project visibility without enterprise complexity."
    />
    <meta property="og:type" content="website" />
    <meta
      property="og:image"
      content="https://ilhzuvemiuyfuxfegtlv.supabase.co/storage/v1/object/public/site-assets//BuildDeskLogo.png"
    />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@builddesk" />
    <meta
      name="twitter:image"
      content="https://ilhzuvemiuyfuxfegtlv.supabase.co/storage/v1/object/public/site-assets//BuildDeskLogo.png"
    />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LNDT7H4SJR"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-LNDT7H4SJR');
    </script>

    <!-- Cache Management & Loop Protection O -->
    <script>
      (function () {
        const CURRENT_VERSION = "2025.08.08.006";
        const lastCacheClear = localStorage.getItem("last_cache_clear");
        const now = Date.now();

        // Periodic cache refresh (once per hour)
        const shouldRefreshCache =
          !lastCacheClear ||
          now - parseInt(lastCacheClear) > 3600000 ||
          localStorage.getItem("app_version") !== CURRENT_VERSION;

        if (shouldRefreshCache) {
          try {
            localStorage.clear();
            sessionStorage.clear();

            if ("serviceWorker" in navigator) {
              navigator.serviceWorker.getRegistrations().then((regs) => {
                regs.forEach((reg) => reg.unregister());
              });
            }

            if ("caches" in window) {
              caches.keys().then((names) => {
                names.forEach((name) => caches.delete(name));
              });
            }

            localStorage.setItem("last_cache_clear", now.toString());
            localStorage.setItem("app_version", CURRENT_VERSION);

            const params = new URLSearchParams(window.location.search);
            if (!params.has("refreshed")) {
              params.set("v", CURRENT_VERSION);
              params.set("refreshed", "true");
              const newURL =
                window.location.origin +
                window.location.pathname +
                "?" +
                params.toString();
              // Use replaceState to avoid creating new history entries and SEO issues
              window.history.replaceState({}, '', newURL);
              return;
            }
          } catch (e) {
            console.error("Cache refresh error:", e);
          }
        }

        // Silent protection against infinite renders
        let accessGrantedCount = 0;
        let lastAccessGranted = 0;
        let protectionActive = false;

        const originalLog = console.log;
        console.log = function (...args) {
          const logStr = args.join(" ");

          // Detect infinite access granted messages
          if (logStr.includes("Access granted for role:")) {
            accessGrantedCount++;
            const now = Date.now();

            if (now - lastAccessGranted < 2000 && accessGrantedCount > 5) {
              if (!protectionActive) {
                protectionActive = true;

                // Silent cache clear and reload
                setTimeout(() => {
                  try {
                    localStorage.clear();
                    sessionStorage.clear();
                    const timestamp = Date.now();
                    window.location.href =
                      window.location.origin + "/auth?refresh=" + timestamp;
                  } catch (e) {
                    window.location.reload(true);
                  }
                }, 500);

                return;
              }
            }

            if (now - lastAccessGranted > 2000) {
              accessGrantedCount = 1;
            }
            lastAccessGranted = now;
          }

          originalLog.apply(console, args);
        };

        // Silent React error handling
        const originalError = console.error;
        console.error = function (...args) {
          const errorStr = args.join(" ");

          if (
            errorStr.includes("Minified React error #301") &&
            !protectionActive
          ) {
            protectionActive = true;
            setTimeout(() => {
              localStorage.clear();
              sessionStorage.clear();
              const timestamp = Date.now();
              window.location.href =
                window.location.origin + "/auth?error_recovery=" + timestamp;
            }, 300);
          }

          originalError.apply(console, args);
        };
      })();
    </script>
  </head>

  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
